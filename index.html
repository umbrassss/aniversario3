<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Carrito — Feria (Móvil)</title>
  <meta name="description" content="Catálogo móvil para preorden con WhatsApp." />
  <style>
    :root{
      /* Paleta ajustada a AZULES */
      --bg:#0b1220;          /* fondo muy oscuro azul */
      --card:#0f1b2e;        /* tarjetas/paneles azul oscuro */
      --muted:#89a1c3;       /* texto secundario azul grisáceo */
      --text:#e6f0ff;        /* texto principal claro */
      --brand:#3b82f6;       /* azul marca (reserva) */
      --accent:#60a5fa;      /* azul claro para acentos/badge */
      --danger:#ef4444;      /* ROJO (mantener para eliminar) */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    /* Evita el rebote/overscroll y el "fondo blanco" en bordes */
    html, body{overscroll-behavior-y:none}
    html{background:#0b1220}

    body{
      margin:0;
      background:linear-gradient(180deg,#0a0f1a,var(--bg));
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      min-height:100svh;
    }
    .wrap{max-width:560px;margin:0 auto;padding:12px 14px 90px}

    header{
      position:sticky;top:0;z-index:20;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg,rgba(15,23,42,.90),rgba(15,23,42,.75));
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    .head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px}
    .brand{font-weight:800;letter-spacing:.3px}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .products{padding:10px}
    .products .title{font-weight:800;font-size:18px;padding:2px 2px 8px 2px}

    /* Tarjeta de producto */
    .product{display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
    .product img{aspect-ratio:4/3;width:100%;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1220}
    .product h3{margin:2px 0 0 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;align-items:center;gap:8px}
    .grow{flex:1 1 auto}
    select,input[type=number],input[type=text],textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1426;color:var(--text)}

    /* Botón base (Agregar / +1) en NARANJA */
    button{
      appearance:none;border:none;cursor:pointer;font-weight:700;letter-spacing:.2px;
      background:linear-gradient(180deg,#f59e0b,#d97706);
      color:#fff;padding:10px 14px;border-radius:12px;
      box-shadow:0 6px 24px rgba(245,158,11,.25),inset 0 1px rgba(255,255,255,.18);
      transition:transform .04s ease,filter .2s ease
    }
    button:hover{filter:brightness(1.05)}button:active{transform:translateY(1px)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--text)}
    .badge{display:inline-block;padding:2px 8px;font-size:12px;border-radius:999px;background:rgba(96,165,250,.18);border:1px solid rgba(96,165,250,.35);color:#dbeafe}

    /* Barra fija */
    .fab-cart{
      position:fixed;left:0;right:0;bottom:0;z-index:30;display:flex;align-items:center;justify-content:center;gap:10px;
      padding:14px env(safe-area-inset-right) calc(14px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      background:linear-gradient(180deg,rgba(12,20,34,.6),rgba(12,20,34,.9));
      border-top:1px solid rgba(255,255,255,.08);backdrop-filter:blur(10px)
    }
    .fab-cart button{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,#f59e0b,#d97706)}

    /* Bottom Sheet (carrito y detalle) */
    .sheet{position:fixed;inset:0;z-index:40;display:none}
    .sheet.open{display:block}
    .sheet .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .sheet .panel{
      position:absolute;left:0;right:0;bottom:0;max-height:88vh;
      background:linear-gradient(180deg,rgba(15,23,42,1),rgba(15,23,42,.98));
      border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow);transform:translateY(100%);transition:transform .25s ease
    }
    .sheet.open .panel{transform:translateY(0)}
    .panel .handle{width:48px;height:5px;background:rgba(255,255,255,.18);border-radius:999px;margin:10px auto}
    .panel .content{padding:8px 12px 16px;overflow:auto;max-height:82vh}

    .cart-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.02)}
    .cart-item img{width:56px;height:42px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.08)}
    .qty{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:4px}
    .qty button{padding:6px 10px;background:transparent;border:none;color:var(--text);font-weight:800}
    .qty input{width:38px;text-align:center;padding:6px 4px;border:none;background:transparent;color:var(--text)}
    .panel .totals{display:grid;gap:6px;font-size:14px;margin-top:8px}
    .panel .totals .line{display:flex;justify-content:space-between}
    .panel .totals .total{font-weight:800;font-size:16px;border-top:1px dashed rgba(255,255,255,.15);padding-top:8px;margin-top:4px}

    /* WhatsApp (verde) */
    .btn-whatsapp{
      background:linear-gradient(180deg,#22c55e,#16a34a);
      display:inline-flex;align-items:center;gap:8px;width:100%;justify-content:center
    }

    /* ==== SLIDERS (scroll-snap) ==== */
    .rail-section{margin:4px 0 2px 0}
    .rail-title{font-size:14px;line-height:1.2;color:var(--muted);font-weight:700;margin:6px 4px 8px 4px;letter-spacing:.2px}

    .rail-wrap{position:relative}
    .rail-wrap::before,
    .rail-wrap::after{
      content:"";
      position:absolute; top:0; bottom:0; width:28px;
      pointer-events:none; z-index:1; transition:opacity .2s ease;
    }
    /* Fades de bordes */
    .rail-wrap::before{left:0; background:linear-gradient(90deg, rgba(11,18,32,.95), rgba(11,18,32,0));}
    .rail-wrap::after{right:0; background:linear-gradient(270deg, rgba(11,18,32,.95), rgba(11,18,32,0));}
    .rail-wrap.hide-left::before{opacity:0}
    .rail-wrap.hide-right::after{opacity:0}
    .rail-wrap.single::before, .rail-wrap.single::after{display:none}

    .rail{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:74%;
      gap:12px;
      overflow-x:auto;
      padding:4px 4px 14px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    @media (min-width:480px){ .rail{grid-auto-columns:60%;} }
    .rail::-webkit-scrollbar{height:6px}
    .rail .product{scroll-snap-align:center}
    .rail .product.is-active{
      transform:scale(1.03);
      border-color:rgba(96,165,250,.45);
      box-shadow:0 8px 24px rgba(59,130,246,.15)
    }
    /* Rail con un solo item: centrado fijo y sin scroll */
    .rail.rail--single{
      display:flex; justify-content:center; overflow:hidden;
    }
    .rail.rail--single .product{width:80%; max-width:420px}

    /* Validación nombre */
    .input-error{border-color:rgba(239,68,68,.9)!important; box-shadow:0 0 0 3px rgba(239,68,68,.15) inset}
    .error-msg{color:var(--danger);font-size:12px;margin-top:4px;display:none}

    .muted.center{text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">Choonkies</div>
      <span id="cartCount" class="badge">0</span>
    </div>
  </header>

  <div class="wrap">
    <!-- CATÁLOGO -->
    <section class="card products">
      <div class="title">Menú</div>
      <div id="products"></div>
    </section>
  </div>

  <!-- FAB / Barra de pedido -->
  <div id="fabCart" class="fab-cart" hidden>
    <button id="openSheet"><strong>Ver pedido</strong> (<span id="fabCount">0</span>) • <span id="fabTotal">$0.00</span></button>
  </div>

  <!-- SHEET (Carrito) -->
  <div id="sheet" class="sheet" aria-hidden="true" role="dialog" aria-labelledby="sheetTitle">
    <div class="overlay" id="closeSheet"></div>
    <div class="panel">
      <div class="handle"></div>
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;">
          <div>
            <div id="sheetTitle" style="font-weight:800;">Tu pedido</div>
            <div class="sub">Paso 2: revisa y envía por WhatsApp</div>
          </div>
          <button id="closeSheetBtn" class="btn-outline">Cerrar</button>
        </div>

        <div id="sheetEmpty" class="muted center" style="padding:10px;border:1px dashed rgba(255,255,255,.12);border-radius:12px;">Aún no has agregado productos.</div>
        <div id="sheetList" style="display:none;display:grid;gap:10px;"></div>

        <div id="sheetForms" style="display:none;margin-top:10px;" class="card">
          <div style="padding:12px;display:grid;gap:8px;">
            <label for="customerName" style="font-weight:700;">Nombre del cliente</label>
            <input id="customerName" type="text" placeholder="Tu nombre" />
            <div class="sub">Lo incluiremos en el mensaje de WhatsApp.</div>
            <div id="nameError" class="error-msg">El nombre es obligatorio.</div>

            <label style="font-weight:700;">Entrega</label>
            <div class="row" role="radiogroup" aria-label="Método de entrega" style="flex-wrap:wrap;gap:10px;">
              <label style="display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;cursor:pointer"><input type="radio" name="delivery" value="Recoger en stand" checked>Recoger en stand</label>
            </div>
            <label for="notes" style="font-weight:700;">Notas</label>
            <textarea id="notes" rows="3" placeholder="Escribe tus indicaciones del pedido aquí…"></textarea>
          </div>
        </div>

        <div class="card" style="margin-top:10px;">
          <div class="content" style="padding-top:8px;">
            <div class="totals">
              <div class="line"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
              <div class="line"><span>Descuentos</span><span id="discounts">$0.00</span></div>
              <div class="line total"><span>Total</span><span id="total">$0.00</span></div>
            </div>
            <div style="height:8px"></div>
            <button id="btnWhatsApp" class="btn-whatsapp" disabled>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20.52 3.48A11.5 11.5 0 0 0 3.48 20.52L2 22l1.48-1.48a11.5 11.5 0 1 0 17.04-17.04z"/><path d="M7 12c1 2 3 4 5 5 0 0 2 1 3 0 1-1 2-2 2-3 0-1-1-1-1-1h-2l-1-2-2-1V8s0-1-1-1-2 1-3 2"/></svg>
              Finalizar pedido por WhatsApp
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SHEET (Detalle de producto) -->
  <div id="detailSheet" class="sheet" aria-hidden="true" role="dialog" aria-labelledby="detailTitle">
    <div class="overlay" id="closeDetail"></div>
    <div class="panel">
      <div class="handle"></div>
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;">
          <div>
            <div id="detailTitle" style="font-weight:800;">Detalle del producto</div>
            <div class="sub">Revisa y agrega al pedido</div>
          </div>
          <button id="closeDetailBtn" class="btn-outline">Cerrar</button>
        </div>

        <div class="card" style="padding:10px;">
          <img id="detailImg" src="" alt="" style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1220;aspect-ratio:4/3;object-fit:cover"/>
          <div style="display:grid;gap:6px;margin-top:10px;">
            <div style="font-weight:800;font-size:16px" id="detailName">Nombre</div>
            <div class="muted" id="detailPrice">$0.00</div>
            <div class="muted" id="detailIngredients">Galleta hecha de masa de galleta</div>
          </div>
          <div style="height:10px;"></div>
          <button id="detailAddBtn" style="width:100%;">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * Catálogo + sliders + validación + bloqueo de overscroll vertical
     */

    // ⚙️ CONFIGURACIÓN
    const STORE_NAME = "Choonkies";
    const CURRENCY = "USD";
    const STORE_WHATSAPP = "593997339248";

    // 🛍️ CATÁLOGO (ingredientes actualizados)
    const CATALOG = [
      { id:"roll-01", name:"Nutella Classic", price:1.00, color:"#3b82f6", ingredients:"Galleta de vainilla con chispas de chocolate y relleno de Nutella", options:null, img:"assets/img/roll-01-nutella-classic.jpg" },
      { id:"roll-02", name:"Cookies n’ cream", price:1.00, color:"#475569", ingredients:"Galleta de vainilla con trozos de galleta oreo y relleno de Nutella", options:null, img:"assets/img/roll-02-cookies-n-cream.jpg" },
      { id:"roll-03", name:"Churro", price:1.00, color:"#b45309", ingredients:"Galleta de canela y relleno de arequipe", options:null, img:"assets/img/roll-03-churro.jpg" },
      { id:"roll-04", name:"Primavera", price:1.00, color:"#10b981", ingredients:"Galleta de vainilla y relleno de mermelada de mora bañada de azúcar glass", options:null, img:"assets/img/roll-04-primavera.jpg" },
      { id:"roll-05", name:"Red Velvet", price:1.00, color:"#ef4444", ingredients:"Galleta de red velvet con chispas de chocolate blanco y relleno de frosting de queso crema", options:null, img:"assets/img/roll-05-red-velvet.jpg" },
      { id:"roll-11", name:"Doble chocolate", price:1.00, color:"#7c3aed", ingredients:"Galleta de chocolate y relleno de Nutella", options:null, img:"assets/img/roll-11-doble-chocolate.jpg" },
      { id:"roll-06", name:"Roll clásico", price:1.50, color:"#6366f1", ingredients:"Cinnamon Roll con frosting de queso crema y canela", options:null, img:"assets/img/roll-06-roll-clasico.jpg" },
      { id:"roll-07", name:"Roll Mora", price:1.50, color:"#8b5cf6", ingredients:"Cinnamon Roll con frosting de queso crema y mermelada de mora", options:null, img:"assets/img/roll-07-roll-mora.jpg" },
      { id:"roll-08", name:"Roll Brownie", price:1.50, color:"#4b5563", ingredients:"Cinnamon Roll con Nutella y chispas de chocolate", options:null, img:"assets/img/roll-08-roll-brownie.jpg" },
      { id:"roll-09", name:"Roll Caramelo", price:1.50, color:"#d97706", ingredients:"Cinnamon Roll con frosting de queso crema y salsa de caramelo", options:null, img:"assets/img/roll-09-roll-caramelo.jpg" },
      { id:"roll-10", name:"Roll Oreo", price:1.50, color:"#111827", ingredients:"Cinnamon Roll con frosting de queso crema y galleta oreo", options:null, img:"assets/img/roll-10-roll-oreo.jpg" },
      { id:"roll-12", name:"Cookie Pot", price:2.00, color:"#22c55e", ingredients:"Cuchareable a base de capas de galleta con chispas de chocolate y muuucha Nutella", options:null, img:"assets/img/roll-12-cookies-pots.jpg" }
    ];

    // Grupos para sliders
    const GROUPS = {
      cookies: ["roll-01","roll-02","roll-03","roll-04","roll-05","roll-11"],
      rolls:   ["roll-06","roll-07","roll-08","roll-09","roll-10"],
      pots:    ["roll-12"]
    };

    // 🧠 Estado
    let cart = loadCart();
    let currentProductId = null;

    // 🧩 Utilidades
    const fmt = new Intl.NumberFormat("es-EC", { style:"currency", currency:CURRENCY, minimumFractionDigits:2 });
    function svgPlaceholder(label, color="#111827"){
      const safe=(s)=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;");
      const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'><stop offset='0%' stop-color='${color}' stop-opacity='.9'/><stop offset='100%' stop-color='${color}' stop-opacity='.6'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><g fill='white' fill-opacity='.08'><circle cx='100' cy='80' r='50'/><circle cx='720' cy='520' r='70'/><rect x='40' y='500' width='180' height='60' rx='12'/></g><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui, sans-serif' font-size='40' fill='white' fill-opacity='.9'>${safe(label)}</text></svg>`;
      return "data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(svg)));
    }

    function saveCart(){
      const payload={ cart, customerName:document.querySelector('#customerName').value||"", notes:document.querySelector('#notes').value||"", delivery:(document.querySelector('input[name="delivery"]:checked').value)||"Recoger en stand" };
      localStorage.setItem("feria_cart_v2", JSON.stringify(payload));
    }
    function loadCart(){
      try{
        const raw=localStorage.getItem("feria_cart_v2");
        if(!raw) return [];
        const data=JSON.parse(raw);
        setTimeout(()=>{
          if(data.customerName && document.querySelector('#customerName')) document.querySelector('#customerName').value=data.customerName;
          if(data.notes && document.querySelector('#notes')) document.querySelector('#notes').value=data.notes;
          if(data.delivery){
            const r=[...document.querySelectorAll('input[name="delivery"]')].find(x=>x.value===data.delivery);
            if(r) r.checked=true;
          }
        }, 0);
        return Array.isArray(data.cart)?data.cart:[];
      }catch{return []}
    }

    // Renderiza los 3 sliders
    function renderCatalog(){
      const $root=document.querySelector('#products');
      $root.innerHTML="";

      renderRail($root, "Cookies", GROUPS.cookies);
      renderRail($root, "Rolls", GROUPS.rolls);
      renderRail($root, "Pots", GROUPS.pots);

      // Delegación de clics: “Agregar” abre detalle; “+1” agrega directo
      $root.addEventListener('click', (e)=>{
        const addId = e.target.getAttribute('data-add');
        const plusId = e.target.getAttribute('data-addq');
        if(addId){ openDetail(addId); return; }
        if(plusId){
          const prod=CATALOG.find(p=>p.id===plusId);
          if(!prod) return;
          addToCart(prod, null);
        }
      });
    }

    function renderRail(root, title, ids){
      const section = document.createElement('div');
      section.className = "rail-section";
      section.innerHTML = `<div class="rail-title">${title}</div><div class="rail-wrap"><div class="rail"></div></div>`;
      root.appendChild(section);

      const rail = section.querySelector('.rail');
      const wrap = section.querySelector('.rail-wrap');

      ids.forEach(id=>{
        const prod = CATALOG.find(p=>p.id===id);
        if(!prod) return;
        const img=prod.img||svgPlaceholder(prod.name, prod.color);
        const node=document.createElement('div');
        node.className='product';
        node.innerHTML=`
          <img src="${img}" alt="${prod.name}" loading="lazy" decoding="async"/>
          <h3>${prod.name}</h3>
          <div class='muted'>${fmt.format(prod.price)}</div>
          <div class='row'>
            <button class='grow' data-add='${prod.id}'>Agregar</button>
            <button class='btn-outline' data-addq='${prod.id}'>+1</button>
          </div>`;
        rail.appendChild(node);
      });

      // Activo + fades + centrado inicial
      setupRailActiveState(rail);
      if(ids.length === 1){
        rail.classList.add('rail--single');
        wrap.classList.add('single');
      }else{
        requestAnimationFrame(()=>{ centerFirstCard(rail); });
      }
      updateRailFades(rail);
      rail.addEventListener('scroll', ()=>updateRailFades(rail), {passive:true});
      window.addEventListener('resize', ()=>centerFirstCard(rail));
    }

    function setupRailActiveState(rail){
      const cards = [...rail.querySelectorAll('.product')];
      if(!cards.length) return;
      const setActive = (el)=> cards.forEach(c=>c.classList.toggle('is-active', c===el));

      const io = new IntersectionObserver((entries)=>{
        let best=null, max=0;
        for(const en of entries){
          if(en.intersectionRatio > max){ max = en.intersectionRatio; best = en.target; }
        }
        if(best && max>0.5) setActive(best);
      }, {root: rail, threshold:[0.5,0.75,1]});
      cards.forEach(c=>io.observe(c));

      let ticking=false;
      rail.addEventListener('scroll', ()=>{
        if(ticking) return;
        ticking = true;
        requestAnimationFrame(()=>{
          const r = rail.getBoundingClientRect();
          const center = r.left + r.width/2;
          let best=null, dist=1e9;
          cards.forEach(c=>{
            const cr=c.getBoundingClientRect();
            const cc=cr.left + cr.width/2;
            const d=Math.abs(cc-center);
            if(d<dist){ dist=d; best=c; }
          });
          if(best) setActive(best);
          ticking=false;
        });
      });

      setActive(cards[0]);
    }

    function centerFirstCard(rail){
      const first = rail.querySelector('.product');
      if(!first || rail.classList.contains('rail--single')) return;
      const offset = first.offsetLeft - (rail.clientWidth - first.clientWidth)/2;
      rail.scrollLeft = Math.max(0, offset);
    }

    function updateRailFades(rail){
      const wrap = rail.parentElement;
      if(!wrap || !wrap.classList.contains('rail-wrap')) return;
      const max = Math.max(0, rail.scrollWidth - rail.clientWidth - 1);
      wrap.classList.toggle('hide-left', rail.scrollLeft <= 2);
      wrap.classList.toggle('hide-right', rail.scrollLeft >= max);
    }

    function addToCart(product, option=null){
      const key=product.id+(option?`__${option}`:"");
      const existing=cart.find(i=>i.key===key);
      if(existing){ existing.qty+=1; } else {
        cart.push({ key, id:product.id, name:product.name, option, price:product.price, img:product.img||svgPlaceholder(product.name, product.color), qty:1 });
      }
      renderCart();
    }

    function changeQty(key, delta){
      const item=cart.find(i=>i.key===key);
      if(!item) return;
      item.qty=Math.max(1, item.qty+delta);
      renderCart();
    }
    function setQty(key, value){
      const n=Math.max(1, Number(value)||1);
      const item=cart.find(i=>i.key===key);
      if(!item) return;
      item.qty=n;
      renderCart();
    }
    function removeItem(key){
      cart=cart.filter(i=>i.key!==key);
      renderCart();
    }

    function renderCart(){
      const $fab=document.querySelector('#fabCart');
      const $fabCount=document.querySelector('#fabCount');
      const $fabTotal=document.querySelector('#fabTotal');
      const $countTop=document.querySelector('#cartCount');
      const $list=document.querySelector('#sheetList');
      const $empty=document.querySelector('#sheetEmpty');
      const $forms=document.querySelector('#sheetForms');
      const $subtotal=document.querySelector('#subtotal');
      const $discounts=document.querySelector('#discounts');
      const $total=document.querySelector('#total');
      const $btn=document.querySelector('#btnWhatsApp');

      const itemCount=cart.reduce((a,b)=>a+b.qty,0);
      let subtotal=0; cart.forEach(i=>subtotal+=i.price*i.qty);
      const discounts=0;
      const total=Math.max(0, subtotal-discounts);

      if($countTop) $countTop.textContent=String(itemCount);

      if(itemCount>0){ $fab.hidden=false; $fabCount.textContent=String(itemCount); $fabTotal.textContent=fmt.format(total); } else { $fab.hidden=true; }

      if(!itemCount){
        $empty.style.display='block';
        $list.style.display='none';
        $forms.style.display='none';
        $btn.disabled=true;
      } else {
        $empty.style.display='none';
        $list.style.display='grid';
        $forms.style.display='block';
        $btn.disabled=false;
        $list.innerHTML='';
        cart.forEach(item=>{
          const node=document.createElement('div');
          node.className='cart-item';
          node.innerHTML=`<img src='${item.img}' alt='${item.name}'/><div><div style='font-weight:700;font-size:14px'>${item.name}${item.option?` — ${item.option}`:''}</div><div class='muted'>${fmt.format(item.price)} c/u</div></div><div style='display:flex;align-items:center;gap:8px;'><div class='qty'><button aria-label='Menos' onclick="changeQty('${item.key}',-1)">−</button><input aria-label='Cantidad' type='number' min='1' value='${item.qty}' oninput="setQty('${item.key}', this.value)"/><button aria-label='Más' onclick="changeQty('${item.key}',1)">+</button></div><button class='btn-outline' style='border-color:rgba(239,68,68,.55);' aria-label='Eliminar' onclick="removeItem('${item.key}')">✕</button></div>`;
          $list.appendChild(node);
        });
      }

      $subtotal.textContent=fmt.format(subtotal);
      $discounts.textContent=fmt.format(discounts);
      $total.textContent=fmt.format(total);
      saveCart();
    }

    // 🧾 WhatsApp (con validación de nombre)
    function buildWhatsAppMessage(){
      const name=(document.querySelector('#customerName').value||'').trim();
      const delivery=(document.querySelector('input[name="delivery"]:checked').value)||'Recoger en stand';
      const notes=(document.querySelector('#notes').value||'').trim();
      let subtotal=0;
      const lines=cart.map(i=>{
        const line=i.price*i.qty; subtotal+=line;
        return `• ${i.qty}× ${i.name}${i.option?` — ${i.option}`:''} — ${fmt.format(line)}`;
      }).join('\n');
      const header=`*Pedido ${STORE_NAME?('— '+STORE_NAME):''}*`;
      const cliente=name?`\nCliente: ${name}`:'';
      const body=`\n\n${lines}`;
      const entrega=`\n\nEntrega: ${delivery}`;
      const notas=notes?`\nNotas: ${notes}`:'';
      const total=`\n\nTotal: ${fmt.format(subtotal)}`;
      const thanks=`\n\n¡Gracias!`;
      return `${header}${cliente}${body}${entrega}${notas}${total}${thanks}`;
    }
    function goWhatsApp(){
      if(!cart.length) return;

      const nameEl = document.querySelector('#customerName');
      const errEl = document.querySelector('#nameError');
      if(!nameEl.value.trim()){
        nameEl.classList.add('input-error');
        if(errEl){ errEl.style.display='block'; }
        nameEl.focus({preventScroll:true});
        nameEl.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }

      const msg=buildWhatsAppMessage();
      const url=`https://wa.me/${STORE_WHATSAPP}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    }

    // 🎛️ Sheet Carrito
    const sheet=document.querySelector('#sheet');
    const openSheetBtn=document.querySelector('#openSheet');
    const closeSheetBtn=document.querySelector('#closeSheetBtn');
    const closeSheetOverlay=document.querySelector('#closeSheet');
    openSheetBtn.addEventListener('click', ()=>{ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); });
    closeSheetBtn.addEventListener('click', ()=>{ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); });
    closeSheetOverlay.addEventListener('click', ()=>{ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); });

    // 🆕 Sheet Detalle
    const detailSheet=document.querySelector('#detailSheet');
    const closeDetailBtn=document.querySelector('#closeDetailBtn');
    const closeDetailOverlay=document.querySelector('#closeDetail');
    const detailAddBtn=document.querySelector('#detailAddBtn');
    const detailImg=document.querySelector('#detailImg');
    const detailName=document.querySelector('#detailName');
    const detailPrice=document.querySelector('#detailPrice');
    const detailIngredients=document.querySelector('#detailIngredients');

    function openDetail(productId){
      const prod = CATALOG.find(p=>p.id===productId);
      if(!prod) return;
      currentProductId = productId;

      detailImg.src = prod.img || svgPlaceholder(prod.name, prod.color);
      detailImg.alt = prod.name;
      detailName.textContent = prod.name;
      detailPrice.textContent = fmt.format(prod.price);
      detailIngredients.textContent = prod.ingredients || "Galleta hecha de masa de galleta";

      detailSheet.classList.add('open');
      detailSheet.setAttribute('aria-hidden','false');
    }
    function closeDetail(){
      detailSheet.classList.remove('open');
      detailSheet.setAttribute('aria-hidden','true');
      currentProductId = null;
    }
    function addCurrentToCart(){
      if(!currentProductId) return;
      const prod = CATALOG.find(p=>p.id===currentProductId);
      if(!prod) return;
      addToCart(prod, null);
      closeDetail();
    }

    closeDetailBtn.addEventListener('click', closeDetail);
    closeDetailOverlay.addEventListener('click', closeDetail);
    detailAddBtn.addEventListener('click', addCurrentToCart);

    // Guardado + limpieza de error al tipear nombre/notas
    document.querySelector('#btnWhatsApp').addEventListener('click', goWhatsApp);
    document.addEventListener('input', (e)=>{
      if(e.target.id==='customerName'){
        e.target.classList.remove('input-error');
        const errEl = document.querySelector('#nameError');
        if(errEl) errEl.style.display='none';
      }
      if(e.target.id==='customerName'||e.target.id==='notes') saveCart();
    });
    document.addEventListener('change', (e)=>{ if(e.target.name==='delivery') saveCart(); });

    // ===== Bloqueo de overscroll (rebote) en extremos =====
    let startY=0, startX=0, activeScrollable=null;

    function getScrollableParent(el){
      while(el && el !== document.body){
        const cs = getComputedStyle(el);
        const oy = cs.overflowY;
        if((oy==='auto' || oy==='scroll') && el.scrollHeight > el.clientHeight){
          return el;
        }
        el = el.parentElement;
      }
      return null;
    }

    document.addEventListener('touchstart',(e)=>{
      if(!e.touches || !e.touches.length) return;
      const t = e.touches[0];
      startY = t.clientY;
      startX = t.clientX;
      activeScrollable = getScrollableParent(e.target);
    }, {passive:true});

    document.addEventListener('touchmove',(e)=>{
      if(!e.touches || !e.touches.length) return;
      const t = e.touches[0];
      const dy = t.clientY - startY;
      const dx = t.clientX - startX;

      // No bloquear gestos predominantemente horizontales (para los sliders)
      if(Math.abs(dx) > Math.abs(dy)) return;

      // Si estamos dentro de un contenedor con scroll vertical (p.ej. sheet)
      if(activeScrollable){
        const el = activeScrollable;
        const atTop = el.scrollTop <= 0;
        const atBottom = Math.ceil(el.scrollTop + el.clientHeight) >= el.scrollHeight;
        if((atTop && dy > 0) || (atBottom && dy < 0)){
          e.preventDefault();
        }
        return;
      }

      // Scroll del viewport (página)
      const atTop = window.scrollY <= 0;
      const atBottom = (window.innerHeight + Math.round(window.scrollY)) >= (document.documentElement.scrollHeight - 1);
      if((atTop && dy > 0) || (atBottom && dy < 0)){
        e.preventDefault();
      }
    }, {passive:false});

    document.addEventListener('touchend', ()=>{ activeScrollable=null; }, {passive:true});
    document.addEventListener('touchcancel', ()=>{ activeScrollable=null; }, {passive:true});

    // Render inicial
    renderCatalog();
    renderCart();
    if(STORE_NAME){ document.title = `Carrito — ${STORE_NAME}`; }
  </script>
</body>
</html>
